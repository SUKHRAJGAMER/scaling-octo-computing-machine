name: VPS Auto Restart (IPv4 Safe)

on:
  schedule:
    - cron: '0 */5 * * *' # every 5 hours
  workflow_dispatch: {}

jobs:
  restart-vps:
    runs-on: ubuntu-latest

    steps:
      - name: üìÇ Checkout repo
        uses: actions/checkout@v4

      - name: üöÄ Run maintenance script on VPS (IPv4 only)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail
            TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")

            BACKUP_DIR="${REMOTE_BACKUP_DIR:-/var/backups/github_maintenance}"
            PATHS="${REMOTE_PATHS:-/etc /var/www}"
            KEEP="${KEEP_BACKUPS:-7}"
            SRV="${SERVICES:-nginx.service}"

            echo "[REMOTE] === VPS Maintenance Started @ $TIMESTAMP ==="

            mkdir -p "$BACKUP_DIR"

            TARFILE="$BACKUP_DIR/backup-$TIMESTAMP.tar.gz"
            echo "[REMOTE] Creating backup: $TARFILE"
            tar -czf "$TARFILE" $PATHS 2>/dev/null || echo "[WARN] Some files missing in backup"

            echo "[REMOTE] Rotating backups (keeping last $KEEP)"
            ls -1t "$BACKUP_DIR"/backup-*.tar.gz 2>/dev/null | sed -n "$((KEEP+1)),\$p" | xargs -r rm --

            for svc in $SRV; do
              echo "[REMOTE] Handling service: $svc"
              if systemctl is-active --quiet "$svc"; then
                echo "[REMOTE] Restarting $svc..."
                systemctl restart "$svc"
              else
                echo "[REMOTE] Starting $svc..."
                systemctl start "$svc"
              fi

              if systemctl is-active --quiet "$svc"; then
                echo "[REMOTE] ‚úÖ $svc is running"
              else
                echo "[REMOTE] ‚ùå $svc failed to start" && exit 2
              fi
            done

            IPV4=$(ip -4 addr show | grep -oP "(?<=inet\\s)\\d+(\\.\\d+){3}" | head -n1 || echo "unknown")
            echo "[REMOTE] Current IPv4: $IPV4"

            echo "[REMOTE] === VPS Maintenance Finished @ $TIMESTAMP ==="
